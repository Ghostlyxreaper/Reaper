name: VPD

on:
  workflow_dispatch:

jobs:
  debian-vpd:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Set up Debian VPD Environment
        run: |
          sudo apt update -y && sudo apt install -y xrdp xfce4 xfce4-goodies wget unzip
          sudo systemctl enable xrdp && sudo systemctl start xrdp
          sudo useradd -m VPD && echo "VPD:Password123!" | sudo chpasswd
          echo "VPD user: VPD | Password: Password123!"
      - name: Install ngrok
        run: |
          wget -qO ngrok.zip https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-linux-amd64.zip
          unzip ngrok.zip
          sudo mv ngrok /usr/local/bin/
      - name: Connect ngrok tunnel
        run: |
          ./ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
          ./ngrok tcp 3389 --region=us > /dev/null &
          sleep 10
          curl -s localhost:4040/api/tunnels | grep -o 'tcp://[^"]*'
      - name: Keep Alive
        run: |
          while true; do echo "[$(date)] VPD Active"; sleep 300; done
